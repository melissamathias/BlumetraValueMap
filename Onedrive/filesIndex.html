<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OneDrive File List</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qs/dist/qs.min.js"></script>
</head>
<body>
<h1>OneDrive File List</h1>
<button onclick="listFiles()">Get Files</button>
<p id="status-message"></p>
<pre id="file-list"></pre>

<script>
    const client_id = "9575f570-860e-4801-8142-682ec0129c27";
    const client_secret = "dd9a8af0-44eb-4b45-a43e-bd8df7f66213";
    const tenant_id = "f939db98-9ab3-4b52-8e5a-0d2b6168b56a";
    const scope = 'https://graph.microsoft.com/.default';
    const grant_type = 'client_credentials';

    function updateStatusMessage(message) {
        document.getElementById('status-message').textContent = message;
    }

    async function getAccessToken() {
        updateStatusMessage('Fetching access token...');
        const token_url = `https://login.microsoftonline.com/${tenant_id}/oauth2/v2.0/token`;
        const payload = {
            client_id,
            client_secret,
            scope,
            grant_type
        };

        try {
            const response = await axios.post(token_url, qs.stringify(payload), {
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            });
            updateStatusMessage('Access token fetched successfully.');
            return response.data.access_token;
        } catch (error) {
            console.error('Error fetching access token:', error.response ? error.response.data : error.message);
            updateStatusMessage('Error fetching access token.');
            throw error;
        }
    }

    async function listFiles() {
        const fileList = document.getElementById('file-list');
        fileList.textContent = '';
        try {
            updateStatusMessage('Fetching access token...');
            const accessToken = await getAccessToken();
            
            updateStatusMessage('Fetching files from OneDrive...');
            const folderUrl = `https://graph.microsoft.com/v1.0/me/drive/root/children`;

            const response = await axios.get(folderUrl, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            const files = response.data.value;
            fileList.textContent = JSON.stringify(files, null, 2);
            updateStatusMessage('Files fetched successfully.');
        } catch (error) {
            console.error('Error listing files:', error.response ? error.response.data : error.message);
            updateStatusMessage('Error listing files.');
            alert('Error listing files: ' + (error.response ? error.response.data.error.message : error.message));
        }
    }
</script>
</body>
</html>
